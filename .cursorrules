# Cursor Rules â€” Governance & Phase Control
# 
# These rules enforce strict phase sequencing and prevent unauthorized implementation
# in high-risk domains (payments, Stripe, plans, trust, escrow).
#
# These are HARD GOVERNANCE CONSTRAINTS, not suggestions.
# Violations are governance failures, not capability failures.

# ============================================================================
# ðŸ”’ Rule 1: Phase Gate Enforcement (Non-Negotiable)
# ============================================================================

This repository follows an explicit phase sequence:
**Schema â†’ Invariants â†’ Tests â†’ Implementation â†’ Integration â†’ UI**.

The agent MUST NOT implement code beyond the explicitly approved phase.

If the current approved task is "write invariants", "write tests", or "generate skeletons", 
the agent MUST NOT implement production logic.

If the next step appears "obvious", the agent MUST STOP and request explicit approval 
before proceeding.

# ============================================================================
# ðŸ”’ Rule 2: Payments / Stripe / Trust Hard Stop
# ============================================================================

Any work involving **Stripe**, **payments**, **escrow**, **plans**, **entitlements**, 
or **trust** is considered high-risk.

For these domains, the default behavior is:
- Specs only
- Skeletons only
- Invariant tests only

The agent MUST NOT implement production logic unless the user explicitly approves 
implementation for that domain and step.

# ============================================================================
# ðŸ”’ Rule 3: Invariants First, Always
# ============================================================================

When invariants are requested:
- The agent must write tests that FAIL against the current implementation or skeleton.
- The agent must NOT implement code to satisfy the invariants unless explicitly instructed.

Invariants define contracts; they do not imply implementation approval.

# ============================================================================
# ðŸ”’ Rule 4: "Implementation Complete" Language Ban
# ============================================================================

The agent MUST NOT claim "implementation complete", "done", or "ready" unless:
- Relevant tests have been executed
- Tests have passed
- The user has approved implementation

Acceptable alternatives include:
- "Implementation drafted"
- "Candidate implementation"
- "Unreviewed implementation on branch"

# ============================================================================
# ðŸ”’ Rule 5: Confirmation Before Execution
# ============================================================================

If the agent determines that the "next logical step" is implementation, integration, 
or mutation of production code, it MUST ask for confirmation before proceeding.

Silence or implication does not count as approval.

# ============================================================================
# ðŸ”’ Rule 6: Branch Discipline for High-Risk Domains
# ============================================================================

Any unapproved implementation touching payments, Stripe, plans, or trust MUST remain 
on a non-main branch and must be explicitly marked as unapproved.

The agent MUST NOT imply merge readiness without tests and approval.

# ============================================================================
# ðŸ§  Rule 7: Intent Echo (Strongly Recommended)
# ============================================================================

Before starting any task involving payments, plans, or trust, the agent must restate:
- The approved step
- The boundaries of what it will and will not do

If the echoed intent is incorrect, the agent must stop.

# ============================================================================
# Additional Context
# ============================================================================

## Phase D (Payments) is LOCKED
- Phase D files are read-only
- Any modification to payment core files is a regression
- Payment invariants are enforced via CI/CD

## Phase Sequence Enforcement
- Schema migrations must be approved before invariants
- Invariants must be written and approved before tests
- Tests must pass before implementation
- Implementation must be reviewed before integration

## High-Risk Domain List
- Stripe webhooks and event processing
- Escrow state transitions
- Plan subscriptions and entitlements
- Trust tier calculations
- Payment processing logic
- Risk level gating

## Safe Domains (Standard Rules Apply)
- UI components
- Non-payment API endpoints
- Documentation
- Test infrastructure
- Build tooling
