# HustleXP Penetration Test Playbook

**Version:** 1.0
**Last Updated:** 2026-02-21
**Classification:** INTERNAL — DO NOT SHARE EXTERNALLY

## 1. Scope & Objectives

### In Scope
| Component | Target | Notes |
|-----------|--------|-------|
| REST/tRPC API | All endpoints via Hono server | Auth, task, escrow, user, proof, dispute, payout, XP, verification, admin routers |
| Authentication | Firebase Auth integration | Token validation, session management, role escalation |
| Escrow/Payment | Stripe PaymentIntent → Escrow flow | INV-2 enforcement, state machine integrity |
| Session Store | Redis via Upstash | Encrypted session tokens (AES-256-GCM) |
| File Upload | R2 via proof photo upload | File type validation, size limits, path traversal |
| Database | Neon PostgreSQL | SQL injection, privilege escalation, row-level access |

### Out of Scope
- Firebase Auth infrastructure (Google-managed)
- Stripe dashboard/API infrastructure
- Railway platform infrastructure
- Client-side mobile app (separate pentest)

## 2. Pre-Test Checklist

- [ ] Staging environment provisioned (never test against production)
- [ ] Test Stripe keys configured (never use live keys)
- [ ] Test Firebase project configured
- [ ] Test database seeded with representative data
- [ ] Incident response contacts identified
- [ ] Legal authorization signed (if external tester)
- [ ] Rollback procedure documented

## 3. Test Categories

### 3.1 Authentication & Authorization (Days 1-2)

#### A1: Firebase Token Manipulation
```
OBJECTIVE: Verify server rejects tampered/expired/missing tokens
TOOLS: curl, jwt.io, custom scripts

TESTS:
- [ ] Request without Authorization header → 401
- [ ] Request with expired token → 401
- [ ] Request with token for wrong project → 401
- [ ] Request with manually crafted JWT (wrong signing key) → 401
- [ ] Request with valid token but revoked user → 401
- [ ] Token reuse after logout/session destroy → 401
```

#### A2: Role & Permission Escalation
```
OBJECTIVE: Verify users cannot access resources outside their role
TOOLS: curl, two test accounts (worker + poster)

TESTS:
- [ ] Worker attempts poster-only operations (task creation) → 403
- [ ] Poster attempts worker-only operations (task acceptance) → 403
- [ ] Non-admin attempts admin routes → 403
- [ ] User A accesses User B's profile data → 403
- [ ] Worker modifies another worker's proof → 403
- [ ] User attempts to change own trust_tier directly → 403
```

#### A3: Session Security
```
OBJECTIVE: Verify session tokens are encrypted at rest and resistant to tampering
TOOLS: redis-cli (if accessible), custom scripts

TESTS:
- [ ] Session data in Redis is not plaintext JSON (encrypted)
- [ ] Tampered session cookie → rejected (null return)
- [ ] Session fixation: pre-set session ID before auth → rejected
- [ ] Session expires after TTL
- [ ] Concurrent sessions from different IPs handled correctly
```

### 3.2 Escrow & Money Path (Days 2-3)

#### M1: Escrow State Machine Integrity (INV-2, INV-4)
```
OBJECTIVE: Verify escrow cannot be manipulated outside valid state transitions
TOOLS: curl, automated scripts

TESTS:
- [ ] Release escrow without task COMPLETED → blocked (INV-2)
- [ ] Release already-released escrow → blocked (terminal state)
- [ ] Fund already-funded escrow → blocked (idempotent)
- [ ] Refund released escrow → blocked
- [ ] Double-spend: two concurrent release requests → only one succeeds
- [ ] Amount manipulation: change payout amount after funding → blocked
- [ ] Cross-user: Worker A triggers release on Worker B's escrow → 403
```

#### M2: Stripe Webhook Integrity
```
OBJECTIVE: Verify webhook endpoint validates signatures and handles replays
TOOLS: curl, stripe CLI

TESTS:
- [ ] Webhook without Stripe-Signature header → 400
- [ ] Webhook with invalid signature → 400
- [ ] Webhook replay (duplicate event ID) → idempotent (no double-fund)
- [ ] Webhook with future timestamp → rejected or handled
- [ ] Webhook for non-existent payment intent → graceful error
- [ ] Webhook payload manipulation (change amount) → signature fails
```

#### M3: Payment Amount Validation
```
OBJECTIVE: Verify price/amount integrity throughout the flow
TOOLS: curl

TESTS:
- [ ] Task creation with price < $5.00 → rejected
- [ ] Task creation with price > $10,000 → rejected (if max exists)
- [ ] PaymentIntent amount != escrow amount → rejected
- [ ] Negative price → rejected
- [ ] Non-integer cents → rejected
- [ ] Currency manipulation (USD → different currency) → rejected
```

### 3.3 Input Validation & Injection (Days 3-4)

#### I1: SQL Injection
```
OBJECTIVE: Verify parameterized queries prevent SQL injection
TOOLS: sqlmap, manual testing

TESTS:
- [ ] Task title: "'; DROP TABLE tasks; --" → stored as literal string
- [ ] Search/filter params with SQL payloads → parameterized
- [ ] UUID fields with non-UUID input → validation error
- [ ] Numeric fields with string input → validation error
- [ ] ORDER BY clause injection (if dynamic sorting) → blocked
```

#### I2: XSS & Content Injection
```
OBJECTIVE: Verify user-generated content is sanitized
TOOLS: manual testing, burp suite

TESTS:
- [ ] Task title with <script> tag → stripped/escaped
- [ ] Task description with HTML → stripped/escaped
- [ ] User bio with JavaScript → stripped/escaped
- [ ] Proof photo EXIF data with script → ignored
- [ ] Error messages don't reflect user input verbatim
```

#### I3: AI Guard Bypass
```
OBJECTIVE: Verify AI output validation catches prompt injection
TOOLS: custom prompts

TESTS:
- [ ] AI response containing system prompt → blocked
- [ ] AI response containing SSN pattern → blocked
- [ ] AI response containing credit card numbers → blocked
- [ ] AI response containing API keys → blocked
- [ ] AI response exceeding 10K chars → truncated
- [ ] AI cost exceeding $50/day budget → blocked
```

### 3.4 Rate Limiting & DoS (Days 4-5)

#### R1: API Rate Limits
```
OBJECTIVE: Verify rate limiting prevents abuse
TOOLS: wrk, k6, custom scripts

TESTS:
- [ ] 100+ requests/sec from single IP → rate limited
- [ ] Task creation spam (>10/min) → rate limited
- [ ] Login attempt brute force (>5/min) → rate limited
- [ ] Webhook endpoint flood → rate limited or queued
- [ ] Large payload (>1MB body) → rejected
- [ ] Slowloris-style slow headers → timeout
```

#### R2: Resource Exhaustion
```
OBJECTIVE: Verify server handles resource exhaustion gracefully
TOOLS: k6, custom scripts

TESTS:
- [ ] Database connection pool exhaustion → graceful 503
- [ ] Redis connection failure → fail-closed (no plaintext fallback in prod)
- [ ] Large file upload (>10MB proof photo) → rejected
- [ ] Deeply nested JSON body → rejected
- [ ] Very long string fields (>10K chars) → truncated/rejected
```

### 3.5 Data Access & Privacy (Days 5-6)

#### D1: Horizontal Privilege Escalation
```
OBJECTIVE: Verify users cannot access other users' data
TOOLS: two test accounts, curl

TESTS:
- [ ] GET /user/:id with another user's ID → own data only or 403
- [ ] GET /task/:id for private task → owner/worker only
- [ ] GET /escrow/:id for another user's escrow → 403
- [ ] GET /proof/:id for another user's proof → 403
- [ ] Enumerate user IDs via sequential requests → UUIDs prevent
- [ ] Access dispute details for uninvolved user → 403
```

#### D2: Data Leakage
```
OBJECTIVE: Verify sensitive data is not exposed in responses
TOOLS: response inspection, curl

TESTS:
- [ ] Error responses don't include stack traces (production)
- [ ] User responses don't include password hashes
- [ ] Escrow responses don't include Stripe internal IDs to non-owners
- [ ] API responses have proper Content-Type headers
- [ ] CORS headers restrict to allowed origins
- [ ] No sensitive data in URL query parameters
```

### 3.6 Infrastructure & Configuration (Day 7)

#### C1: Security Headers
```
OBJECTIVE: Verify HTTP security headers are present
TOOLS: curl, securityheaders.com

TESTS:
- [ ] X-Content-Type-Options: nosniff
- [ ] X-Frame-Options: DENY
- [ ] Strict-Transport-Security present
- [ ] Content-Security-Policy present
- [ ] X-XSS-Protection: 0 (rely on CSP instead)
- [ ] No Server header leaking version info
```

#### C2: Environment & Secrets
```
OBJECTIVE: Verify no secrets are exposed
TOOLS: manual review, trufflehog

TESTS:
- [ ] No API keys in source code
- [ ] No database URLs in client-facing responses
- [ ] Environment variables not logged
- [ ] Git history clean of secrets (trufflehog scan)
- [ ] .env files in .gitignore
- [ ] Error pages don't reveal internal paths
```

## 4. Tools Required

| Tool | Purpose | License |
|------|---------|---------|
| curl | Manual HTTP testing | Free |
| Burp Suite Community | Proxy/intercept | Free |
| sqlmap | SQL injection testing | Free |
| trufflehog | Secret scanning | Free |
| k6 | Load/stress testing | Free |
| stripe CLI | Webhook testing | Free |
| jwt.io | Token inspection | Free |
| nuclei | Automated vulnerability scanning | Free |

## 5. Severity Classification

| Severity | Definition | SLA |
|----------|-----------|-----|
| **CRITICAL** | Money path bypass, auth bypass, data breach | Fix before launch |
| **HIGH** | Privilege escalation, session hijack, injection | Fix within 48 hours |
| **MEDIUM** | Rate limit bypass, information disclosure | Fix within 1 week |
| **LOW** | Missing headers, verbose errors | Fix within 1 month |

## 6. Reporting Template

```
## Finding: [TITLE]
**Severity:** CRITICAL / HIGH / MEDIUM / LOW
**Category:** Auth / Escrow / Injection / Config
**Status:** Open / In Progress / Fixed / Accepted Risk

### Description
[What was found]

### Steps to Reproduce
1. ...
2. ...
3. ...

### Impact
[What an attacker could achieve]

### Remediation
[How to fix it]

### Evidence
[Screenshots, request/response logs]
```

## 7. Schedule (7-Day Sprint)

| Day | Focus | Tests |
|-----|-------|-------|
| 1 | Auth & Session | A1, A2, A3 |
| 2 | Auth completion + Escrow start | A3, M1 |
| 3 | Money path & Stripe | M1, M2, M3 |
| 4 | Input validation & Injection | I1, I2, I3 |
| 5 | Rate limiting & DoS | R1, R2 |
| 6 | Data access & Privacy | D1, D2 |
| 7 | Infrastructure & Reporting | C1, C2, Final Report |

## 8. Post-Test Actions

1. **Findings Report** — Deliver within 2 business days
2. **Remediation Tracking** — Create GitHub issues for each finding
3. **Re-Test** — Verify fixes within 1 week
4. **Lessons Learned** — Update this playbook with new test cases
5. **Schedule Next Test** — Quarterly for pre-revenue, monthly post-revenue
